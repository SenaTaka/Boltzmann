# 2D3V Boltzmann方程式 BGKモデル 数値シミュレーション

## 概要

このプログラムは、無次元化されたBoltzmann方程式BGKモデルを用いた2次元空間・3次元速度空間（2D3V）の数値シミュレーションです。平板周りのMaxwell反射を含む流体解析を行います。

## ファイル構成

- `src.c` - オリジナルのソースコード
- `src_refactored.c` - リファクタリング済みソースコード（推奨）
- `REFACTORING.md` - リファクタリングの詳細ドキュメント

## 参考文献

Mieussens, L. and Struchtrup, H., "Numerical comparison of Bhatnagar-Gross-Krook models with proper Prandtl number," Physics of Fluids, Vol. 16, No. 8, 2004, pp. 2797–2813.

## 主な機能

- **数値解法**: 2次Runge-Kutta法による時間積分
- **空間離散化**: 2次精度Upwind差分法（Minmodリミッタ使用）
- **局所速度分布**: Newton法を用いた非平衡分布関数の計算
- **境界条件**: 
  - Maxwell反射境界条件（平板壁面）
  - 流入・流出境界条件
- **並列化**: OpenMPによる並列計算対応

## 数値条件

### 空間メッシュ
- x方向: 55グリッド（Δx = 2.0×10⁻² m）
- y方向: 45グリッド（Δy = 1.25×10⁻² m）

### 速度空間メッシュ
- cx, cy: 各100グリッド（Δc = 0.125）
- cz: 60グリッド（Δc = 0.2）

### 初期条件
- 左側領域（流入）:
  - 数密度: n = 1.000
  - 速度: v₁ = 4.564, v₂ = 0.0
  - 温度: T = 1.000
  - 圧力: p = 1.000

### 物性値（アルゴンガス）
- 分子質量: M = 6.6339×10⁻²⁶ kg
- 分子半径: r = 1.85×10⁻¹⁰ m
- 参照温度: Tref = 273 K
- 粘性指数: ω = 0.81

## コンパイル方法

### リファクタリング版（推奨）

```bash
gcc -fopenmp -O3 -march=native -ffast-math -funroll-loops src_refactored.c -o sim -lm
```

### オリジナル版

```bash
gcc -fopenmp -O2 src.c -o src -lm
```

### コンパイルオプション（リファクタリング版）
- `-fopenmp`: OpenMP並列化の有効化
- `-O3`: 最適化レベル3（積極的なループ最適化・インライン展開）
- `-march=native`: ネイティブCPU命令セット使用（AVX2/AVX-512など）
- `-ffast-math`: 高速数値演算（IEEE準拠を一部緩和）
- `-funroll-loops`: ループアンローリングの促進
- `-lm`: 数学ライブラリのリンク

注意: 数値的にシビアな検証を行う場合は `-ffast-math` を外すことを推奨します。

## 実行方法

### リファクタリング版

```bash
./sim
```

### オリジナル版

```bash
./src
```

### 並列スレッド数の変更

プログラム内（186行目）でOpenMPのスレッド数が設定されています：
```c
omp_set_num_threads(20);
```

お使いの環境に合わせて変更してください。

## 出力ファイル

### マクロ物理量（CSVファイル）
- ファイル名: `2d3v_maxwellRefrection_flatPlate_XXXXXXX_t.csv`
- 出力内容: 位置座標、数密度、速度、圧力、温度、平均自由行程
- 出力タイミング: 1000ステップごと

### 速度分布関数（CSVファイル）
- ディレクトリ: `f_output_XXXXXXX_t/`
- ファイル名: `f_i,j.csv`（各空間点ごと）
- 出力内容: 速度座標と分布関数値
- 出力タイミング: 5000ステップごと

## プログラム構成

### 主要な関数
- `initialCondition()`: 初期条件の設定
- `boundaryCondition()`: 境界条件の適用
- `localf_eq_Newton()`: Newton法による局所平衡分布の計算
- `flux_x()`, `flux_y()`: 数値流束の計算
- `timeStep_RK2_1st()`, `timeStep_RK2_2nd()`: 2次Runge-Kutta時間積分
- `integral()`: マクロ物理量の計算（数値積分）
- `cfl_check()`: CFL条件に基づく時間刻み幅の決定

### データ構造
- 5次元配列: 速度分布関数 `f[nx][ny][ncj][nck][ncl]`
- 2次元配列: マクロ物理量（密度、速度、圧力、温度など）

## 計算手順

1. 初期条件の設定
2. 各時間ステップで以下を実行：
   - 境界条件の適用
   - 局所平衡分布の計算（Newton法）
   - 数値流束の計算（高次精度スキーム）
   - CFL条件チェックと時間刻み幅の決定
   - 時間積分（2次Runge-Kutta法）
   - マクロ物理量の計算
   - 衝突周波数などの更新
3. 定期的に結果をCSVファイルに出力

## 注意事項

- メモリ使用量が大きいため、十分なRAMが必要です
- 並列計算のため、マルチコアCPUでの実行を推奨します
- 計算時間は設定するステップ数と空間・速度空間の解像度に依存します

## ライセンス

本プログラムは研究・教育目的で使用してください。

